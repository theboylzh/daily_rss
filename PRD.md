# Daily RSS 项目需求文档

## 项目概述

Daily RSS 是一个自动化的 RSS 新闻抓取和分析系统，能够定时从多个 RSS 源获取新闻，进行时间过滤和内容提取，最终通过 AI 分析并发送邮件通知。

## 核心功能需求

### 1. 时间解析和过滤功能

#### 需求描述
- 正确提取 24 小时内的新闻
- 使用东八区时间作为基准进行过滤
- 支持多种时间格式的解析
- 处理不同 RSS 源的时间表示差异

#### 技术实现方案

**时间解析方案：**
1. **多格式支持**：
   - 优先尝试 ISO 格式解析（`datetime.fromisoformat`）
   - 次尝试 feedparser 内置的 `published_parsed` 字段（使用 `time.mktime` 转换）
   - 最后尝试使用 `dateutil.parser` 解析（如果可用）

2. **时区处理**：
   - 统一转换为东八区时间（UTC+8）
   - 对于带时区信息的时间：使用 `astimezone` 转换
   - 对于不带时区信息的时间：假设为 UTC 时间，直接加 8 小时
   - 移除时区信息，便于后续比较

3. **错误处理**：
   - 捕获所有解析异常，确保程序不崩溃
   - 对于解析失败的情况，返回 25 小时前的时间，确保在下次抓取时被过滤

**24小时过滤方案：**
1. **基准时间计算**：
   - 使用东八区时间作为基准：`datetime.now() + timedelta(hours=8) - timedelta(hours=24)`
   - 计算 24 小时前的时间作为过滤阈值

2. **过滤逻辑**：
   - 遍历所有新闻条目，解析发布时间
   - 与阈值比较，保留 24 小时内的新闻
   - 对于日期解析失败的条目，默认保留

3. **日志记录**：
   - 记录过滤阈值和每条新闻的过滤结果
   - 提供清晰的过滤统计信息

### 2. 内容提取功能

#### 需求描述
- 从不同 RSS 源的不同字段提取内容
- 处理不同 RSS 源的内容结构差异
- 清理 HTML 标签，提供干净的文本内容
- 确保内容提取的可靠性和一致性

#### 技术实现方案

**内容提取方案：**
1. **多字段支持**：
   - 按优先级尝试从以下字段提取内容：
     - `content`（列表格式，包含 `value` 属性）
     - `summary`（直接文本）
     - `description`（直接文本）
     - `fulltext`（直接文本）
     - `encoded`（直接文本）
     - `content:encoded`（直接文本）
     - `summary_detail`（对象格式，包含 `value` 属性）
     - `content_detail`（对象格式，包含 `value` 属性）

2. **结构处理**：
   - 处理 `content` 字段的列表格式（取第一个元素的 `value`）
   - 处理 `summary_detail` 等对象格式（直接取 `value` 属性）
   - 处理直接文本格式（直接使用）

3. **内容清理**：
   - 使用 BeautifulSoup 清理 HTML 标签
   - 保留文本内容，去除 HTML 标记
   - 处理空白字符，确保内容干净

### 3. 日志增强功能

#### 需求描述
- 添加详细的抓取和解析日志
- 记录每个 RSS 源的处理状态和结果
- 提供清晰的错误信息，便于调试
- 确保日志信息的可读性和完整性

#### 技术实现方案

**日志实现方案：**
1. **抓取日志**：
   - 记录每个 RSS 源的抓取开始和结束
   - 记录使用的 URL 和抓取尝试次数
   - 记录抓取结果和获取的新闻数量

2. **解析日志**：
   - 记录时间解析的尝试和结果
   - 记录内容提取的字段和结果
   - 记录 HTML 标签清理前后的内容长度

3. **过滤日志**：
   - 记录过滤阈值（东八区时间）
   - 记录每条新闻的发布时间和过滤结果
   - 记录过滤前后的新闻数量统计

4. **错误日志**：
   - 记录网络请求错误和异常
   - 记录时间解析和内容提取的失败情况
   - 提供详细的错误类型和错误信息

### 4. 多 RSS 源支持

#### 需求描述
- 支持不同结构的 RSS 源
- 处理不同 RSS 源的内容格式差异
- 确保对现有 RSS 源的向后兼容
- 提供良好的扩展性，便于添加新的 RSS 源

#### 技术实现方案

**多源支持方案：**
1. **结构适配**：
   - 通过多字段提取适配不同 RSS 源的内容结构
   - 处理 Atom 和 RSS 两种主要格式的差异
   - 支持不同命名空间的内容字段

2. **向后兼容**：
   - 保持现有的 API 接口不变
   - 确保对现有 RSS 源的处理逻辑兼容
   - 渐进式修改，不破坏现有功能

3. **扩展性**：
   - 模块化的内容提取和时间解析逻辑
   - 清晰的错误处理和日志记录
   - 便于添加新的字段支持和格式处理

## 技术架构

### 核心模块

1. **NewsFetcher** 类：
   - `_parse_published_date()`：时间解析和时区处理
   - `_filter_recent_news()`：24小时过滤逻辑
   - `_extract_content()`：内容提取和清理
   - `_fetch_from_subscription()`：单个 RSS 源的抓取

2. **辅助函数**：
   - `_is_rsshub_url()`：检测 RSSHub URL
   - `_replace_rsshub_instance()`：替换 RSSHub 实例
   - `_deduplicate_news()`：新闻去重
   - `_save_news()`：保存新闻到文件

### 依赖项

- **核心依赖**：
  - `feedparser`：RSS 解析
  - `requests`：HTTP 请求
  - `beautifulsoup4`：HTML 解析和内容清理
  - `python-dateutil`：高级时间解析（可选）

- **标准库**：
  - `datetime`：时间处理
  - `time`：时间戳转换
  - `json`：数据序列化
  - `os`：文件操作
  - `ssl`：SSL 上下文管理

## 测试策略

### 测试场景

1. **时间解析测试**：
   - ISO 格式时间（带时区）
   - RSS 格式时间（如 "Mon, 16 Feb 2026 12:00:00 GMT"）
   - 普通格式时间（如 "2026-02-16 12:00:00"）
   - 边界情况和异常格式

2. **内容提取测试**：
   - `content` 字段（列表格式）
   - `summary` 字段（直接文本）
   - `description` 字段（直接文本）
   - `summary_detail` 字段（对象格式）
   - 无内容字段的情况

3. **过滤逻辑测试**：
   - 1小时前的新闻（应保留）
   - 12小时前的新闻（应保留）
   - 24小时前的新闻（应保留，边界情况）
   - 25小时前的新闻（应过滤）
   - 无效日期的新闻（应保留）

4. **多 RSS 源测试**：
   - `https://moonvy.com/blog/rss.xml`（WordPress RSS）
   - `https://quail.ink/dingyi/feed/atom`（Atom 格式）
   - `https://www.ifanr.com/feed`（自定义 RSS）

### 测试结果

| 测试项 | 预期结果 | 实际结果 | 状态 |
|--------|----------|----------|------|
| 时间解析（ISO格式） | 正确解析并转换为东八区时间 | ✅ 成功 | 通过 |
| 时间解析（RSS格式） | 正确解析并转换为东八区时间 | ✅ 成功 | 通过 |
| 时间解析（普通格式） | 正确解析并转换为东八区时间 | ✅ 成功 | 通过 |
| 内容提取（content字段） | 成功提取并清理内容 | ✅ 成功 | 通过 |
| 内容提取（summary字段） | 成功提取并清理内容 | ✅ 成功 | 通过 |
| 内容提取（description字段） | 成功提取并清理内容 | ✅ 成功 | 通过 |
| 24小时过滤（1小时前） | 保留该新闻 | ✅ 成功 | 通过 |
| 24小时过滤（24小时前） | 保留该新闻（边界情况） | ✅ 成功 | 通过 |
| 24小时过滤（25小时前） | 过滤该新闻 | ✅ 成功 | 通过 |
| 24小时过滤（无效日期） | 保留该新闻 | ✅ 成功 | 通过 |
| 多RSS源抓取（moonvy） | 成功抓取并处理 | ✅ 成功 | 通过 |
| 多RSS源抓取（quail.ink） | 成功抓取并处理 | ✅ 成功 | 通过 |
| 多RSS源抓取（ifanr） | 成功抓取并处理 | ✅ 成功 | 通过 |

## 部署说明

### 环境要求

- Python 3.10+
- 依赖项：`feedparser`, `requests`, `beautifulsoup4`, `python-dotenv`, `schedule`, `pydantic`, `pydantic-settings`, `openai`, `tavily-python`, `markdown2`

### 配置文件

- `.env`：包含敏感配置（API 密钥、邮箱信息等）
- `config.py`：系统配置参数

### 部署流程

1. **本地部署**：
   - 克隆代码库
   - 安装依赖：`pip install -r requirements.txt`
   - 复制 `.env.example` 为 `.env` 并填写配置
   - 运行：`python main.py`

2. **GitHub Actions 部署**：
   - 配置 GitHub Secrets（AI_API_KEY, EMAIL_SENDER, EMAIL_RECEIVER, EMAIL_PASSWORD）
   - 启用 `.github/workflows/rss-tool.yml` 工作流
   - 工作流会定时运行，抓取新闻并发送邮件

### 运行机制

1. **定时执行**：
   - 通过 GitHub Actions 定时触发
   - 每日任务：UTC 0 点（北京时间早上 8 点）
   - 每周任务：周一 UTC 0 点（北京时间周一早上 8 点）
   - 每月任务：每月 1 日 UTC 0 点（北京时间每月 1 日早上 8 点）
   - 本地部署可使用系统定时任务（如 crontab）

2. **执行流程**：
   - 读取订阅源配置
   - 遍历每个订阅源进行抓取
   - 解析时间和提取内容
   - 过滤 24 小时内的新闻
   - 保存新闻到本地文件
   - 进行 AI 分析（三层分析：第一层概要、第二层事件、第三层详细）
   - 发送邮件通知（HTML 格式）
   - 清理过期数据（保留 60 天）

## 监控和维护

### 日志监控

- 系统会生成详细的抓取和处理日志（`rss_tool.log`）
- 关注以下日志信息：
  - 抓取失败的 RSS 源
  - 时间解析失败的条目
  - 内容提取为空的条目
  - 过滤结果的统计信息
  - AI 分析结果

### 常见问题处理

1. **RSS 源抓取失败**：
   - 检查网络连接
   - 验证 RSS 源 URL 是否有效
   - 检查 RSS 源是否有访问限制

2. **AI 分析失败**：
   - 检查 AI API 密钥是否有效
   - 验证 API 调用频率是否超过限制
   - 检查网络连接是否稳定

3. **邮件发送失败**：
   - 检查邮箱配置是否正确
   - 验证邮箱密码（应用密码）是否有效
   - 检查邮箱的 SMTP 服务是否已开启

4. **时间解析错误**：
   - 检查 RSS 源的时间格式
   - 检查时区设置是否正确

5. **内容提取为空**：
   - 检查 RSS 源的内容结构
   - 确认是否需要添加新的内容字段支持

## 后续优化建议

1. **性能优化**：
   - 实现并发抓取，提高多 RSS 源的处理速度
   - 缓存已解析的 RSS 源信息，减少重复解析

2. **功能增强**：
   - 添加更多内容提取规则，支持更多 RSS 源格式
   - 实现智能分类和标签功能
   - 添加用户界面，便于管理订阅源和查看历史新闻
   - 支持更多推送方式（如 Telegram、飞书等）

3. **可靠性提升**：
   - 实现更完善的错误重试机制
   - 添加 RSS 源健康检查
   - 实现更灵活的时间过滤策略

4. **扩展性**：
   - 设计插件系统，支持自定义处理器
   - 提供 API 接口，便于与其他系统集成
   - 支持更多输出格式（如 JSON、Markdown）

## 结论

本项目通过渐进式的技术改进，成功实现了以下目标：

1. **时间解析和过滤**：使用东八区时间作为基准，正确过滤 24 小时内的新闻
2. **内容提取增强**：支持从多种字段提取内容，处理不同 RSS 源的结构差异
3. **日志系统完善**：提供详细的抓取和处理日志，便于调试和监控
4. **多 RSS 源支持**：成功处理不同格式和结构的 RSS 源

所有功能均已通过测试验证，系统运行稳定，能够满足日常 RSS 新闻抓取和分析的需求。